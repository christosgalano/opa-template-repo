# File: .github/workflows/push-policy-bundle.yaml
#
# Description:
# Push an OPA policy bundle (bundle.tar.gz) to an Azure Storage Account.
#
# - Validates policies first by calling .github/workflows/ci.yaml
# - Builds an OPA bundle from a given path (e.g. policy/, terraform/, terraform/azuredevops)
# - Verifies the path exists before bundling
# - Uploads the bundle to a single Azure Blob Storage container: "policy-library"
#
# Requirements:
# - Reusable CI workflow at .github/workflows/ci.yaml
# - Repo secrets:
#     AZURE_CLIENT_ID
#     AZURE_TENANT_ID
#     AZURE_SUBSCRIPTION_ID
# - Repo variables:
#     POLICY_STORAGE_ACCOUNT: Azure Storage Account Name
#     STORAGE_CONTAINER: Azure Storage Container Name
#

name: Push Policy Bundle

on:
  workflow_dispatch:
    inputs:
      bundle_path:
        description: >
          Path to bundle (relative to repo root), e.g.:
          - policy
          - terraform
          - terraform/azuredevops
        required: true
        default: 'policy'
        type: string
      blob_name:
        description: >
          Optional blob name (defaults to <bundle_path-with-slashes-replaced>.tar.gz
          if left empty)
        required: false
        default: ''
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Rego Policy Validation
    uses: ./.github/workflows/ci.yaml
    secrets: inherit

  push-bundle:
    name: Push Policy Bundle to Storage
    needs: validate
    runs-on: ubuntu-latest

    env:
      BUNDLE_PATH: ${{ inputs.bundle_path }}
      POLICY_STORAGE_ACCOUNT: ${{ vars.POLICY_STORAGE_ACCOUNT }}
      STORAGE_CONTAINER: ${{ vars.POLICY_STORAGE_CONTAINER }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Ensure bundle path exists
        run: |
          echo "Bundle path: ${BUNDLE_PATH}"
          if [ ! -d "${BUNDLE_PATH}" ]; then
            echo "::error::Bundle path '${BUNDLE_PATH}' does not exist."
            exit 1
          fi

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build OPA bundle
        run: |
          echo "##[section] Building OPA bundle from path: ${BUNDLE_PATH}"

          # Normalize path (strip trailing slash)
          NORMALIZED_PATH="${BUNDLE_PATH%/}"

          echo "Normalized path: ${NORMALIZED_PATH}"
          echo "opa build --bundle \"${NORMALIZED_PATH}\" --output bundle.tar.gz --revision $(git rev-parse HEAD)"

          if ! opa build --bundle "${NORMALIZED_PATH}" --output bundle.tar.gz --revision "$(git rev-parse HEAD)"; then
            echo "::error::OPA build failed"
            exit 1
          fi

          echo "OPA build completed successfully."

      - name: Compute blob name
        id: blob
        run: |
          INPUT_BLOB_NAME="${{ inputs.blob_name }}"

          if [ -n "${INPUT_BLOB_NAME}" ]; then
            BLOB_NAME="${INPUT_BLOB_NAME}"
          else
            # Derive from path: terraform/azuredevops -> terraform-azuredevops.tar.gz
            NORMALIZED_PATH="${BUNDLE_PATH%/}"
            SAFE_NAME="$(echo "${NORMALIZED_PATH}" | tr '/' '-')"
            BLOB_NAME="${SAFE_NAME}.tar.gz"
          fi

          echo "Using blob name: ${BLOB_NAME}"
          echo "blob_name=${BLOB_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload bundle to Azure Storage
        run: |
          if [ -z "${POLICY_STORAGE_ACCOUNT}" ]; then
            echo "::error::POLICY_STORAGE_ACCOUNT secret is not set."
            exit 1
          fi

          BLOB_NAME="${{ steps.blob.outputs.blob_name }}"

          echo "Uploading bundle.tar.gz to:"
          echo "  Account   : ${POLICY_STORAGE_ACCOUNT}"
          echo "  Container : ${STORAGE_CONTAINER}"
          echo "  Blob name : ${BLOB_NAME}"

          az storage blob upload \
            --account-name "${POLICY_STORAGE_ACCOUNT}" \
            --container-name "${STORAGE_CONTAINER}" \
            --name "${BLOB_NAME}" \
            --file bundle.tar.gz \
            --overwrite true \
            --auth-mode login

      - name: Logout from Azure
        if: always()
        run: az logout || true
